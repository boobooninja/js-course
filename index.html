<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Quizzy</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/foundation/5.3.0/css/foundation.min.css" type="text/css" />
    <script type="text/css">
    </script>
  </head>
  <body>
    <div class="row">
      <div class="medium-12 large-12 column">
        <div class="panel">
          <h2>Quizzy</h2>
          <div id="main"></div>
        </div>
      </div>
    </div>

    <div id="templates">
      <script type="text/template" id="start">
        <div class="start">
          <input type="text" id="user" placeholder="Input your name">
          <button id="start">Start Quiz</button>
        </div>
      </script>

      <script type="text/template" id="quizQuestion">
        <div id="quiz">
          <div id="question">Question: {{= question }}</div>
          <div id="buttonsTF">
            <button class="answerButton" data-value=true>True</button>
            <button class="answerButton" data-value=false>False</button>
          </div>
        </div>
      </script>

      <script type="text/template" id="quizAnswer">
        <div id="quiz">
          <div id="question">Question: {{= question }}</div>
          <div id="answer">Answer: {{= answer }}</div>
          <div id="reason">Reason: {{= reason }}</div>
          <div id="score">Your Score: {{= score }}</div>
          <div id="nextButton">
            <button id="next">Next</button>
          </div>
        </div>
      </script>

      <script type="text/template" id="scores">
        <h3>Scores</h3>
        <div id="scores">{{= scores }}</div>
        <div id="newGame">
          <button id="newGameButton">Play again</button>
        </div>
      </script>

      <script type="text/template" id="scoreLine">
        <div id="scoreLine">Name: {{= name }} Score: {{= score }}</div>
      </script>

    </div>

    <!-- body goes here -->
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/foundation/5.3.0/js/foundation.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.2/backbone-min.js"></script>
    <script type="text/javascript">
      (function() {
        $(document).foundation();
      })();

      (function(){
        _.templateSettings = {
          evaluate    : /\{\{([\s\S]+?)\}\}/g,
          interpolate : /\{\{=([\s\S]+?)\}\}/g,
          escape      : /\{\{-([\s\S]+?)\}\}/g
        };

        // ----- Templates
        var startHTML = $('#templates #start').html();
        var startTemplate = _.template(startHTML);

        var quizQuestionHTML = $('#templates #quizQuestion').html();
        var quizQuestionTemplate = _.template(quizQuestionHTML);

        var quizAnswerHTML = $('#templates #quizAnswer').html();
        var quizAnswerTemplate = _.template(quizAnswerHTML);

        var scoresHTML = $('#templates #scores').html();
        var scoresTemplate = _.template(scoresHTML);

        var scoreLineHTML = $('#templates #scoreLine').html();
        var scoreLineTemplate = _.template(scoreLineHTML);

        var counter = -1;
        var score = 0;
        var highScores = [];
        var questionList = [
          { id: 1,
            question: "An acute angle is less than 90 degrees",
            answer: true,
            reason: "An obtuse angle is greater than 90 degrees."
          },
          { id: 2,
            question: "The bear has caused more human deaths than any other mammal in history.",
            answer: false,
            reason: "The rat, a frequent carrier of disease, has been the deadliest mammal."
          },
          { id: 3,
            question: "The highest-grossing film series in history is Star Wars.",
            answer: false,
            reason: "The Harry Potter series is first; the James Bond series, second; and Star Wars, third."
          },
          { id: 4,
            question: "In her novel The Fountainhead, Ayn Rand promoted the virtues of communal efforts over individualism.",
            answer: false,
            reason: "In her 1943 novel, which reflects Rand's anticommunist philosophy of 'objectivism,' a genius architect battles conformist mediocrity."
          },
          { id: 5,
            question: "Napoleon Bonaparte was killed at the Battle of Waterloo.",
            answer: false,
            reason: "Napoleon surrendered to the British after his defeat at Waterloo and died in exile on the island of St. Helena."
          },
          { id: 6,
            question: "Apartheid was the political system dismantled in South Africa at the end of the 20th century.",
            answer: true,
            reason: "Apartheid - the system of legal, racial segregation - governed South Africa from 1948-1994."
          },
          { id: 7,
            question: "Dubai is home to the tallest man-made structure ever built.",
            answer: true,
            reason: "The 162-floor skyscraper named Burj Khalifa opened in 2010 in Dubai, United Arab Emirates."
          },
          { id: 8,
            question: "'E Pluribus Unum,' on the seal of the United States, means 'one, out of many.'",
            answer: true,
            reason: "It's a motto that emphasizes national unity."
          },
          { id: 9,
            question: "The sport saved from extinction by President Theodore Roosevelt was football.",
            answer: true,
            reason: "Until his 1905 call for regulation of the sport, football was dwindling in support due to its violence - 18 football players died that year."
          },
          { id: 10,
            question: "Oxygen makes up two-thirds of Earth and also two-thirds of the human body.",
            answer: false,
            reason: "Water is the most common substance at roughly these amounts."
          }
        ];

        function nextQuestion() {
          counter += 1;
          return questionList[counter];
        }

        function currentQuestion() {
          return questionList[counter];
        }

        function startQuiz(user) {
          counter = -1;
          score = 0;
          this.user = user;
        }

        function getScore() {
          return score;
        }

        function validate(value) {
          var answer = questionList[counter].answer;
          if (value === answer) {
            score += 1;
          }
        }

        function quizOver() {
          if ( counter >= questionList.length - 1 ) {
            return true;
          } else {
            return false;
          }
        }

        function getHighScores() {
          return highScores.sort(
            function(a,b) {
              return (a.score > b.score) ? -1 : ((b.score > a.score) ? 1 : 0);
            }
          );
        }

        function saveScore() {
          highScores.push( {name: quiz.user, score: quiz.getScore()} )
        }

        window.quiz = {
          nextQuestion: nextQuestion,
          currentQuestion: currentQuestion,
          startQuiz: startQuiz,
          getScore: getScore,
          validate: validate,
          quizOver: quizOver,
          getHighScores: getHighScores,
          saveScore: saveScore
        };

        // ---- VIEW LAYER
        var StartView = Backbone.View.extend({
          template: startTemplate,
          render: function() {
            this.$el.html( this.template( {} ) );
            return this;
          },
          events: {
            "click #start": function() {
              var user = this.$el.find("#user").val();
              console.log(user);
              quiz.startQuiz(user);
              // render quiz question view
              quizQuestionView.render();
            }
          }
        });

        window.startView = new StartView({
          el: "#main"
        });

        var QuizQuestionView = Backbone.View.extend({
          template: quizQuestionTemplate,
          render: function() {
            this.$el.html( this.template( quiz.nextQuestion() ) );
            return this;
          },
          events: {
            "click .answerButton": function(e) {
              var value = $(e.currentTarget).data('value');
              console.log(value);
              quiz.validate(value);
              // render answer view
              quizAnswerView.render();
            }
          }
        });

        window.quizQuestionView = new QuizQuestionView({
          el: "#main"
        });

        var QuizAnswerView = Backbone.View.extend({
          template: quizAnswerTemplate,
          render: function() {
            var data = quiz.currentQuestion();
            data.score = quiz.getScore();
            this.$el.html( this.template( data ) );
            return this;
          },
          events: {
            "click #next": function(e) {

              if (quiz.quizOver()) {
                quiz.saveScore();
                // render scores view
                scoresView.render();
              } else {
                // render next question view
                quizQuestionView.render();
              }
            }
          }
        });

        window.quizAnswerView = new QuizAnswerView({
          el: "#main"
        });

        var ScoresView = Backbone.View.extend({
          template: scoresTemplate,
          scoreLineTemplate: scoreLineTemplate,
          render: function() {
            var scores = quiz.getHighScores();
            var str ="";
            for (var i = 0; i < scores.length; i++) {
              str += this.scoreLineTemplate( scores[i] );
            }

            this.$el.html( this.template( {scores: str} ) );
            return this;
          },
          events: {
            "click #newGameButton": function() {
              // render start view
              startView.render();
            }
          }
        });

        window.scoresView = new ScoresView({
          el: "#main"
        });


      })();

      startView.render();

    </script>
  </body>
</html>
